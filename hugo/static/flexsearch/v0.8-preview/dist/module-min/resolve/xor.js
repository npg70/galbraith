import Resolver from"../resolver.js";import default_resolver from"./default.js";import{create_object}from"../common.js";Resolver.prototype.xor=function(){const a=this;let b=arguments,c=b[0];if(c.then)return c.then(function(){return a.xor.apply(a,b)});if(c[0]&&c[0].index)return this.xor.apply(this,c);let d,e,f=[],g=[],h=0,i=0;for(let a,c=0;c<b.length;c++)if(a=b[c]){let b;if(a.constructor===Resolver)b=a.result;else if(a.constructor===Array)b=a;else if(a.index)a.resolve=!1,b=a.index.search(a).result;else if(a.or)b=this.or(a.or);else if(a.and)b=this.and(a.and);else if(a.not)b=this.not(a.not);else{h=a.limit||0,i=a.offset||0,d=a.enrich,e=a.resolve;continue}f[c]=b,b.then&&g.push(b)}return g.length?Promise.all(g).then(function(){return a.result.length&&(f=[a.result].concat(f)),a.result=exclusive(f,h,i,d,!e,a.boostval),e?a.result:a}):(this.result.length&&(f=[this.result].concat(f)),this.result=exclusive(f,h,i,d,!e,a.boostval),e?this.result:this)};function exclusive(a,b,c,d,e,f){if(!a.length)return a;if(2>a.length)return e?default_resolver(a[0],b,c,d):a[0];const g=[],h=create_object();for(let g,j=0;j<a.length;j++)if(g=a[j],g)for(let a,b=0;b<g.length;b++)if(a=g[b],a)for(let b,c=0;c<a.length;c++)b=a[c],h[b]?h[b]++:h[b]=1;for(let k,l=0;l<a.length;l++)if(k=a[l],k)for(let a,b=0;b<k.length;b++)if(a=k[b],a)for(let c,d=0;d<a.length;d++)if(c=a[d],1===h[c])if(e)g.push(c);else{const a=b+(l?f:0);g[a]||(g[a]=[]),g[a].push(c)}return g}