import{SearchOptions}from"../type.js";import{create_object,is_object,sort_by_length_down}from"../common.js";import Index from"../index.js";import default_compress from"../compress.js";import Resolver from"../resolver.js";import{intersect}from"../intersect.js";import resolve_default from"../resolve/default.js";let global_resolve=1;export function set_resolve(a){global_resolve=a}Index.prototype.search=function(a,b,c){c||(!b&&is_object(a)?(c=a,a=""):is_object(b)&&(c=b,b=0));let d,e,f,g,h,i,j=[],k=0;if(c?(a=c.query||a,b=c.limit||b,k=c.offset||0,e=c.context,f=c.suggest,g=global_resolve&&!1!==c.resolve,g||(global_resolve=0),h=g&&c.enrich,i=this.db&&c.tag):g=this.resolve||global_resolve,a=this.encoder.encode(a),d=a.length,b||!g||(b=100),1===d)return single_term_query.call(this,a[0],"",b,k,g,h,i);if(e=this.depth&&!1!==e,2===d&&e&&!f)return single_term_query.call(this,a[0],a[1],b,k,g,h,i);let l=0,m=0;if(1<d){const b=create_object(),c=[];for(let e,h=0;h<d;h++)if(e=a[h],e&&!b[e]){if(!f&&!this.db&&!this.get_array(e))return g?j:new Resolver(j);c.push(e),b[e]=1;const a=e.length;l=Math.max(l,a),m=m?Math.min(m,a):a}a=c,d=a.length}if(!d)return g?j:new Resolver(j);let n,o=0;if(1===d)return single_term_query.call(this,a[0],"",b,k,g,h,i);if(2===d&&e&&!f)return single_term_query.call(this,a[0],a[1],b,k,g,h,i);if(1<d&&(e?(n=a[0],o=1):9<l&&3<l/m&&a.sort(sort_by_length_down)),this.db){if(this.db.search){const c=this.db.search(this,a,b,k,f,g,h,i);if(!1!==c)return c}const c=this;return async function(){for(let e,h;o<d;o++){if(h=a[o],n?(e=await c.get_array(h,n),e=add_result(e,j,f,c.resolution_ctx,b,k,2===d),(!f||!1!==e||!j.length)&&(n=h)):(e=await c.get_array(h),e=add_result(e,j,f,c.resolution,b,k,1===d)),e)return e;if(f&&o==d-1){let a=j.length;if(!a){if(n){n="",o=-1;continue}return j}if(1===a)return g?resolve_default(j[0],b,k):new Resolver(j[0])}}return g?intersect(j,c.resolution,b,k,f):new Resolver(j[0])}()}for(let e,h;o<d;o++){if(h=a[o],n?(e=this.get_array(h,n),e=add_result(e,j,f,this.resolution_ctx,b,k,2===d),(!f||!1!==e||!j.length)&&(n=h)):(e=this.get_array(h),e=add_result(e,j,f,this.resolution,b,k,1===d)),e)return e;if(f&&o==d-1){const a=j.length;if(!a){if(n){n="",o=-1;continue}return j}if(1===a)return g?resolve_default(j[0],b,k):new Resolver(j[0])}}return j=intersect(j,this.resolution,b,k,f),g?j:new Resolver(j)};function single_term_query(a,b,c,d,e,f,g){const h=this.get_array(a,b,c,d,e,f,g);return this.db?h.then(function(a){return e?a:a&&a.length?e?resolve_default(a,c,d):new Resolver(a):e?[]:new Resolver([])}):h&&h.length?e?resolve_default(h,c,d):new Resolver(h):e?[]:new Resolver([])}function add_result(a,b,c,d,e,f,g){let h=[];if(a){d=Math.min(a.length,d);for(let b,c=0,i=0;c<d&&!((b=a[c])&&(f&&b&&g&&(b.length<=f?(f-=b.length,b=null):(b=b.slice(f),f=0)),b&&(h[c]=b,g&&(i+=b.length,i>=e))));c++);if(h.length)return g?resolve_default(h,e,0):void b.push(h)}return!c&&h}Index.prototype.get_array=function(a,b,c,d,e,f,g){let h,i;return(b&&(i=this.bidirectional&&a>b),this.compress&&(a=default_compress(a),b&&(b=default_compress(b))),this.db)?b?this.db.get(i?b:a,i?a:b,c,d,e,f,g):this.db.get(a,"",c,d,e,f,g):(b?(h=this.ctx.get(i?a:b),h=h&&h.get(i?b:a)):h=this.map.get(a),h)};